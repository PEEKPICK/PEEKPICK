# í¬íŒ… ë§¤ë‰´ì–¼

íƒœê·¸: ìš´ì˜ & ìœ ì§€ë³´ìˆ˜
ë§ˆê°ì¼: 2023ë…„ 8ì›” 16ì¼
ìˆ™ì œ ì—¬ë¶€: O
ì™„ë£Œ: No

### 1. ë²„ì „ ì •ë³´

**Cloud Server**   **:  Amazon EC2**

**Web Server     :  Nginx**

**Image Server  :  AWS S3**

**DB Server        :  AWS RDS**

### Backend

```json
"Java"            : "OpenJDK 11.0.1"
"Spring"          : "5.3.29"
"Spring Boot"     : "2.7.14"
"Spring Security" : "5.7.10"
"Gradle"          : "8.1.1"
```

- **application.yml**
    
    ```yaml
    server:
      tomcat:
        threads:
          max: 200
          min-spare: 10
        accept-count: 100
        mbeanregistry:
          enabled: true
      port: 8081
      http2:
        enabled: true
    
    spring:
      servlet:
        mulipart:
          max-file-size: 10MB
          max-request-size: 10MB
      config:
        import: classpath:application-db.yml
      security:
        oauth2:
          client:
            registration:
              google:
                client-id: [ê°œë°œì ì„¼í„°ì— ë“±ë¡ëœ ì•„ì´ë””]
                client-secret: [ê°œë°œì ì„¼í„°ì— ë“±ë¡ëœ ì‹œí¬ë¦¿ í‚¤]
                redirect-uri: https://i9b309.p.ssafy.io/api/login/oauth2/code/google
                scope: openid,profile,email
              naver:
                client-id: [ê°œë°œì ì„¼í„°ì— ë“±ë¡ëœ ì•„ì´ë””]
                client-secret: [ê°œë°œì ì„¼í„°ì— ë“±ë¡ëœ ì‹œí¬ë¦¿ í‚¤]
                authorization-grant-type: authorization_code
                client-name: naver
                redirect-uri: http://i9b309.p.ssafy.io/login/oauth2/code/naver
                scope: profile,email
              kakao:
                client-id: [ê°œë°œì ì„¼í„°ì— ë“±ë¡ëœ ì•„ì´ë””]
                client-secret: [ê°œë°œì ì„¼í„°ì— ë“±ë¡ëœ ì‹œí¬ë¦¿ í‚¤]
                client-authentication-method: POST
                authorization-grant-type: authorization_code
                client-name: kakao
                redirect-uri: https://i9b309.p.ssafy.io/api/login/oauth2/code/kakao
                scope: openid, profile_nickname, account_email
    
            provider:
              naver:
                authorization-uri: https://nid.naver.com/oauth2.0/authorize
                token-uri: https://nid.naver.com/oauth2.0/token
                user-info-uri: https://openapi.naver.com/v1/nid/me
                user-name-attribute: response
              kakao:
                issuer-uri: https://kauth.kakao.com
                authorization-uri: https://kauth.kakao.com/oauth/authorize
                token-uri: https://kauth.kakao.com/oauth/token
                user-info-uri: https://kapi.kakao.com/v1/oidc/userinfo
                jwk-set-uri: https://kauth.kakao.com/.well-known/jwks.json
                user-name-attribute: id
      mvc:
        static-path-pattern: /static/**
      datasource:
        hikari:
          connectionTimeout: 30000
          maximumPoolSize : 20
          maxLifetime : 295000
          poolName: HikariCP
          readOnly: false
    
    auth:
      secretKey: [ìš°ë¦¬ ì„œë¹„ìŠ¤ë¥¼ ì¦ëª…í•˜ëŠ” Signning Key]
      redirectUrl: https://i9b309.p.ssafy.io
      ignored-urls: /login, /member/test, /member/signup, /member/login, /member/emoji,
                      /member/prefix, /member/world, /member/taste, /member/signup/info, /picker/sse, /ws/**,
                      /actuator/prometheus
    
    management:
      endpoints:
        web:
          exposure:
            include:
              - info
              - health
              - loggers
              - mappings
              - metrics
              - prometheus
    ```
    
- **application-db.yml**
    
    ```yaml
    spring:
      datasource:
        url: jdbc:mysql://[AWS RDS ì£¼ì†Œ]:8309/peekpick_db
        username: [DB Username]
        password: [DB password]
        driver-class-name: com.mysql.cj.jdbc.Driver
      jpa:
        open-in-view: false
        show-sql: true
        hibernate:
          ddl-auto: update
        properties:
          hibernate:
            format_sql: true
      redis:
        host: [ë„ë©”ì¸ ì£¼ì†Œ or ì„œë²„ IP ì£¼ì†Œ]
        port: 6379
        password: [Redis ë¹„ë°€ë²ˆí˜¸]
    cloud:
      aws:
        credentials:
          access-key: [S3 ë²„í‚·ì˜ IM ì‚¬ìš©ì ì•¡ì„¸ìŠ¤ í‚¤]
          secret-key: [S3 ë²„í‚·ì˜ IM ì‚¬ìš©ì ë¹„ë°€í‚¤]
        s3:
          bucket: peekpick-app
        region:
          static: ap-northeast-2
          auto: false
        stack:
          auto: false
    ```
    

<aside>

ğŸš¨ Application ì„¤ì •íŒŒì¼ì€ ```ê³¼ê¸ˆ```ì´ ë  ìˆ˜ ìˆëŠ” ë¯¼ê°ì •ë³´ë“¤ì´ ì¡´ì¬í•˜ë¯€ë¡œ, ```Jenkins``` ì»¨í…Œì´ë„ˆ ë‚´ë¶€ì— í™˜ê²½ì— ë³„ë„ë¡œ ì‘ì„±

</aside>

### Frontend

```json
"React"          : "18.2.0"
"Redux"          : "8.1.1"
"Redux tool kit" : "1.9.5"
"npm"            : "9.6.7"
"node.js"        : "18.17.0"
"Axios"          : "1.4.0"
```

### Database

```json
"MySQL" : "8.0.33"
"Redis" : "3.2"
```

### Infra

```json
"Ubuntu"     : "20.0.4 LTS"
"Jenkins"    : "2.417"
"Docker"     : "24.0.5"
"Nginx"      : "1.18.0 (Ubuntu)"
"Prometheus" : "1.9.13"
"Grafana"    : "Latest"
```

### 2. í¬íŠ¸ ì •ë³´

| Port | ìš©ë„ | ê°œë°© |
| --- | --- | --- |
| 22 | SSH | â­• |
| 80 | NGINX | â­• |
| 443 | NGINX | â­• |
| 8888 | Jenkins | â­• |
| 8081 | BE PJT | âŒ |
| 3000 | FE PJT | âŒ |

### 3. EC2 ì‚¬ì „ ì„¤ì •

```bash
$ sudo apt-get update

# Docker ì„¤ì¹˜
# íŒ¨í‚¤ì§€ ì„¤ì¹˜
$ sudo apt-get install apt-transport-https ca-certificates curl gnupg-agent software-properties-common
# Docker GPG í‚¤ ì¶”ê°€
$ curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo apt-key add -
# Docker apt repository ì¶”ê°€
$ sudo add-apt-repository "deb [arch=amd64] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable"

# ì‹œìŠ¤í…œ ì—…ë°ì´íŠ¸
$ sudo apt-get update
$ sudo apt-get install docker-ce docker-ce-cli containerd.io
```

**Nginx**

```bash
$ sudo apt-get install nginx

# SSL ì¸ì¦ì„ ìœ„í•œ Certbot, LetsEncrypt
$ sudo apt-get install certbot python3-certbot-nginx
$ sudo apt-get install letsencrtypt

# Certbotì„ í†µí•œ SSL ì¸ì¦ì„œ ë°œê¸‰
$ sudo certbot --nginx
```

```bash
# Nginx ì„¤ì •íŒŒì¼
# /etc/nginx/conf.d/default.conf 

limit_req_zone $binary_remote_addr:$uri zone=request_limit_per_ip:10m rate=3r/s;

server {
        server_name i9b309.p.ssafy.io;

        location / {
                proxy_pass http://localhost:3000;
        }

        location /api/ {
                proxy_pass http://localhost:8081/;
                proxy_set_header Connection '';
                proxy_http_version 1.1;
                proxy_read_timeout 86400;
                limit_req zone=request_limit_per_ip burst=5 delay=10;
                limit_req_status 429;
        }

        location /ws {
                proxy_pass http://localhost:8081;
                proxy_http_version 1.1;
                proxy_set_header Upgrade $http_upgrade;
                proxy_set_header Connection "Upgrade";
                proxy_set_header Host $host;
        }

    listen [::]:443 ssl http2 ipv6only=on;
    listen 443 ssl http2; # managed by Certbot
    ssl_certificate /etc/letsencrypt/live/i9b309.p.ssafy.io/fullchain.pem; # managed by Certbot
    ssl_certificate_key /etc/letsencrypt/live/i9b309.p.ssafy.io/privkey.pem; # managed by Certbot
    include /etc/letsencrypt/options-ssl-nginx.conf; # managed by Certbot
    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem; # managed by Certbot
}

server {
    if ($host = i9b309.p.ssafy.io) {
        return 301 https://$host$request_uri;
    } # managed by Certbot

    server_name i9b309.p.ssafy.io;
    listen 80;
    return 404; # managed by Certbot
}
```

### Jenkins

```bash
# Jenkins ì´ë¯¸ì§€ PULL
$ sudo docker pull jenkins/jenkins:jdk11 
# Jenkins ì»¨í…Œì´ë„ˆ ì‹¤í–‰
$ sudo docker run -d -p 8888:8080 --name jenkins jenkins/jenkins:jdk11
```

### Redis

```bash
# Redis ì´ë¯¸ì§€ PULL
$ sudo docker pull redis:3.2
# Redis ì»¨í…Œì´ë„ˆ ì‹¤í–‰
$ sudo docker run -d -p 6379:6379 --name peekpick_redis redis:3.2
```

### 4. ë°°í¬

**Backend**

```docker
# BE Dockerfile
FROM openjdk:11-jdk

#COPY usr/spring/resources ./resources

COPY build/libs/*.jar application.jar

EXPOSE 8081

ENTRYPOINT ["java","-jar", "application.jar"]
```

```go
// BE Jenkinsfile
pipeline {
    agent any
    stages {
        stage("Set Variable") {
            steps {
                script {
                    IMAGE_NAME_BE = "peekpick-springboot"
                    IMAGE_STORAGE = "https://registry.hub.docker.com"
                    IMAGE_STORAGE_CREDENTIAL = "docker-hub"
                    APPLICATION_YML_PATH = "/usr/spring/resources"
                    CONTAINER_NAME_BE = "peekpick_be"
                    PROJECT_DIR_BE = "backend"
                }
            }
        }

        // ì„¤ì •íŒŒì¼ ì°¸ì¡°
        stage("copy yml") {
            steps {
                sh "cp -r ${APPLICATION_YML_PATH} ${PROJECT_DIR_BE}/src/main"
            }
        }

        // ë°±ì—”ë“œ í”„ë¡œì íŠ¸ ë¹Œë“œ
        stage("be build") {
            // build
            steps{
                sh """
                cd ${PROJECT_DIR_BE}
                chmod 777 ./gradlew
                ls -al
                pwd
                ./gradlew clean build
                """
            }
        }

        // ì»¨í…Œì´ë„ˆ í´ë¦¬ë‹
        stage("container cleaning") {
            steps{
                sh "docker ps -q -f name=${CONTAINER_NAME_BE} | xargs --no-run-if-empty docker container stop"    
                sh "docker container ls -a -q -f name=${CONTAINER_NAME_BE} | xargs --no-run-if-empty docker rm"
            }
        }

        // ì´ë¯¸ì§€ ì‚­ì œ
        stage("image cleaning") {
            steps{
                sh "docker images ${IMAGE_NAME_BE} -q | xargs -r docker rmi -f"
            }
        }
        
        // ë„ì»¤ ì´ë¯¸ì§€ ë¹Œë“œ
        stage("be image build") {
            steps {
                dir("${PROJECT_DIR_BE}") {
                    script {
                        sh "docker build --no-cache -t ${IMAGE_NAME_BE} ."
                    }
                }
            }
        }

        // ì»¨í…Œì´ë„ˆ ì‹¤í–‰
        stage("be container run") {
            steps {
                script {
                    sh "docker run -d -p 8081:8081 --name ${CONTAINER_NAME_BE} ${IMAGE_NAME_BE} -e TZ=Asia/Seoul"
                }
            }
        }
    }
}
```

**Frontend**

```docker
# FE Dockerfile

FROM node:18-alpine AS build

ENV NODE_ENV production

CMD [ "cd", "/frontend" ]

COPY package.json .

RUN npm cache clean --force

RUN npm install

COPY . .

RUN npm run build

FROM nginx:1.21.3-alpine

COPY nginx.conf /etc/nginx/nginx.conf

COPY --from=build /build /usr/share/nginx/html

EXPOSE 3000

CMD [ "nginx", "-g", "daemon off;" ]
```

```go
// Frontend Jenkinsfile
pipeline {
    agent any
    stages {
        stage("Set Variable") {
            steps {
                script {
                    IMAGE_NAME_FE = "peekpick-react"
                    IMAGE_STORAGE = "https://registry.hub.docker.com"
                    IMAGE_STORAGE_CREDENTIAL = "docker-hub"
                    CONTAINER_NAME_FE = "peekpick_fe"
                    PROJECT_DIR_FE = "frontend"
                }
            }
        }

        // ì»¨í…Œì´ë„ˆ í´ë¦¬ë‹
        stage("container cleaning") {
            steps{
                sh "docker ps -q -f name=${CONTAINER_NAME_FE} | xargs --no-run-if-empty docker container stop"    
                sh "docker container ls -a -q -f name=${CONTAINER_NAME_FE} | xargs --no-run-if-empty docker rm"
            }
        }

        // ì´ë¯¸ì§€ ì‚­ì œ
        stage("image cleaning") {
            steps{
                sh "docker images ${IMAGE_NAME_FE} -q | xargs -r docker rmi -f"
            }
        }
        
        // ë„ì»¤ ì´ë¯¸ì§€ ë¹Œë“œ
        stage("image build") {
            steps {
                dir("${PROJECT_DIR_FE}") {
                    script {
                        sh "docker build --no-cache -t ${IMAGE_NAME_FE} ."
                    }
                }
            }
        }

        // ì»¨í…Œì´ë„ˆ ì‹¤í–‰
        stage("fe container run") {
            steps {
                script {
                    sh "docker run -d -p 3000:3000 --name ${CONTAINER_NAME_FE} ${IMAGE_NAME_FE}"
                }
            }
        }
    }
}
```

### 5. ì™¸ë¶€ API

**KAKAO Login**

[Kakao Developers](https://developers.kakao.com/product/kakaoLogin)

**Naver Login**

[ë„¤ì´ë²„ ë¡œê·¸ì¸ - INTRO](https://developers.naver.com/products/login/api/api.md)

**Google Login**

[ì›¹ ì•±ì— Google ë¡œê·¸ì¸ í†µí•©     Â |Â  Authentication Â |Â  Google for Developers](https://developers.google.com/identity/sign-in/web/sign-in?hl=ko)